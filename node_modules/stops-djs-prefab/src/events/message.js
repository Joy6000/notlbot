const Discord = require('discord.js')
const prettyMs = require('pretty-ms')

module.exports = (client, handler, message) => {
    const array = require('../handlers/command')
    const { prefix, owners, commands } = handler 
    
    // if (message.author.id === '776516976679583774') return
    if (message.author.bot) return;
    if (!message.content.startsWith(prefix)) return;

    const args = message.content.substring(prefix.length).split(/ /g)
    const commandName = args[0].toLowerCase()
    args.shift()

    const commandOBJ = commands.get(commandName) || commands.find(cmd => cmd.aliases && cmd.aliases.length && cmd.aliases.includes(commandName))

    if (!commandOBJ) return

    if (commandName.ownerOnly && !owners.includes(message.author.id)) return

    if (commandOBJ.guildOnly && !message.guild) return message.reply('This command can only be used in a server.')

    if (commandOBJ.reqArgs && commandOBJ.reqArgs > args.length) {
        if (commandOBJ.usage) {
            message.channel.send(`Incorrect usage, or you haven't provided enough options for this command. Use: ${prefix}${commandName} ${commandOBJ.usage} next time.`)
            return
        } else {
            message.channel.send('Incorrect usage, or you haven\'t provided enough options for this command. There doesn\'t seem to be a `usage` property. Try contacting one of the bot developers.')
            return
        }
    }

    if(commandOBJ.maxArgs && commandOBJ.maxArgs < args.length) {
        if (commandOBJ.usage) {
            return message.channel.send(`Incorrect usage, or you have provided too many options for this command. Use: ${prefix}${commandName} ${commandOBJ.usage} next time.`)
        } else {
            return message.channel.send('Incorrect usage, or you have provided too many options for this command. There doesn\'t seem to be a usage specified. Contact a developer if you believe there should be.')
        }
    }

    if (commandOBJ.nsfwOnly && !message.channel.nsfw) {
        message.channel.send('This channel isn\'t nsfw :P take it somewhere else, for example an actual nsfw channel this time.')
        return
    }
    if (commandOBJ.reqPerms) {
        if (message.guild) {
            const missingPermission = message.channel.permissionsFor(message.member).missing(message.channel.permissionsFor(message.member).bitfield)
            console.log(message.channel.permissionsFor(message.member).bitfield)
            if (missingPermission.length) {
                message.reply(`You kinda need the ${missingPermission.map(perm => `${perm.toLowerCase().replace('_', ' ')}`).join(', ')} permission(s) to use the command.`)
                return
            }
        }
    }
    if (commandOBJ.reqBotPerms) {
        if (message.guild) {
            const missingPermission = message.channel.permissionsFor(message.guild.me).missing(commandOBJ.reqBotPerms)
            if (missingPermission) {
                message.reply(`I kinda need the ${missingPermission.map(perm => `${perm.toLowerCase().replace('_', ' ')}`).join(', ')} permission(s) to run the command.`)
                return
            }
        }
    }
    if (commandOBJ.requiredRoles) {
        if (message.guild) {
            const role = message.guild.roles.cache.find(r => r.name === commandOBJ.requiredRoles)

            if (!role) throw new TypeError(`The role ${role} does not exist in ${message.guild.name}. Please use an existing role next time please thanks`)

            if (!message.member.roles.cache.has(role.id)) return
        }
    }
    const cooldowns = handler.cooldowns;

    if (!cooldowns.has(commandOBJ.name)) {
        cooldowns.set(commandOBJ.name, new Discord.Collection());
    }
    
    const now = Date.now();
    const timestamps = cooldowns.get(commandOBJ.name);
    const cooldownAmount = (commandOBJ.cooldown || handler.defaultCooldown) * 1000;
    
    if (timestamps.has(message.author.id)) {
        const expirationTime = timestamps.get(message.author.id) + cooldownAmount;

        if (now < expirationTime) {
            const timeLeft = (expirationTime - now) / 1000;
            const exactTime = timeLeft.toFixed(0);
            return message.reply(`There is a cooldown. It is ${prettyMs(parseInt(exactTime) * 1000,  {verbose: true})}. Please come back later (Command: c!${commandOBJ.name})`);
        }    
    }

    timestamps.set(message.author.id, now);
    setTimeout(() => timestamps.delete(message.author.id), cooldownAmount);

    try {
        commandOBJ.execute({ message, args, client, handler, array })
    } catch (err) {
        message.reply(`There was an error processing your request. The command that this issue is occuring in is called ${commandName}. If this persists try contacting the bot developer.`)
        console.log(err)
    }

}